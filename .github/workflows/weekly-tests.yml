name: Weekly E2E Tests

on:
  # Run every Monday at 6:00 AM UTC
  schedule:
    - cron: '0 6 * * 1'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      priority_filter:
        description: 'Test priority filter'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - p0
          - p1
          - p2

env:
  NODE_VERSION: '20'

jobs:
  weekly-smoke-tests:
    name: Weekly Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: vetify_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Generate Prisma Client
        run: pnpm prisma generate

      - name: Create test environment file
        run: |
          cat > .env.local << 'EOF'
          # CI environment for weekly tests
          DATABASE_URL=postgresql://postgres:postgres@localhost:5432/vetify_test
          DIRECT_URL=postgresql://postgres:postgres@localhost:5432/vetify_test
          KINDE_SITE_URL=http://localhost:3000
          KINDE_POST_LOGOUT_REDIRECT_URL=http://localhost:3000
          KINDE_POST_LOGIN_REDIRECT_URL=http://localhost:3000/dashboard
          KINDE_ISSUER_URL=https://test.kinde.com
          KINDE_CLIENT_ID=test_client_id
          KINDE_CLIENT_SECRET=test_client_secret
          VETIFY_API_URL=http://localhost:3000
          NEXT_PUBLIC_APP_URL=http://localhost:3000
          NEXT_PUBLIC_BASE_URL=http://localhost:3000
          STRIPE_SECRET_KEY=sk_test_fake_key_for_ci
          STRIPE_WEBHOOK_SECRET=whsec_fake_secret_for_ci
          EOF

      - name: Push database schema
        run: pnpm prisma db push --skip-generate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/vetify_test
          DIRECT_URL: postgresql://postgres:postgres@localhost:5432/vetify_test

      - name: Seed subscription plans
        run: npx tsx scripts/seed-ci-plans.ts
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/vetify_test
          DIRECT_URL: postgresql://postgres:postgres@localhost:5432/vetify_test

      - name: Build application
        run: pnpm build
        env:
          SKIP_ENV_VALIDATION: true
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/vetify_test
          DIRECT_URL: postgresql://postgres:postgres@localhost:5432/vetify_test

      - name: Run weekly smoke tests
        id: run_tests
        run: |
          GREP_FILTER=""
          if [[ "$PRIORITY_FILTER" == "p0" ]]; then
            GREP_FILTER="--grep '@p0'"
          elif [[ "$PRIORITY_FILTER" == "p1" ]]; then
            GREP_FILTER="--grep '@p1'"
          elif [[ "$PRIORITY_FILTER" == "p2" ]]; then
            GREP_FILTER="--grep '@p2'"
          fi
          pnpm exec playwright test --config playwright.weekly.config.ts $GREP_FILTER
        env:
          CI: true
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/vetify_test
          DIRECT_URL: postgresql://postgres:postgres@localhost:5432/vetify_test
          PRIORITY_FILTER: ${{ github.event.inputs.priority_filter }}

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: weekly-test-report
          path: |
            playwright-report-weekly/
            test-results/weekly-results.json
          retention-days: 30

      - name: Upload test traces on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: weekly-test-traces
          path: test-results/
          retention-days: 14

      - name: Create summary
        if: always()
        run: |
          echo "## Weekly Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "$TEST_OUTCOME" == "success" ]]; then
            echo "### :white_check_mark: All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### :x: Some tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the test report artifact for details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Filter:** ${PRIORITY_FILTER:-all}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** $GITHUB_REF_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** $GITHUB_RUN_ID" >> $GITHUB_STEP_SUMMARY
        env:
          TEST_OUTCOME: ${{ steps.run_tests.outcome }}
          PRIORITY_FILTER: ${{ github.event.inputs.priority_filter }}

  # Optional: Notify on failure
  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: weekly-smoke-tests
    if: failure()
    steps:
      - name: Create issue on critical failure
        uses: actions/github-script@v7
        with:
          script: |
            const dateStr = new Date().toISOString().split('T')[0];
            const title = `Weekly Smoke Tests Failed - ${dateStr}`;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = `
            ## Weekly Smoke Tests Failed

            The weekly smoke tests have failed. Please investigate.

            **Run URL:** ${runUrl}

            **Next Steps:**
            1. Review the test report artifact
            2. Identify failing tests
            3. Determine if it's a test issue or real regression
            4. Fix and verify

            ---
            _This issue was automatically created by the Weekly E2E Tests workflow._
            `;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'weekly-tests,automated',
              state: 'open'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['weekly-tests', 'automated', 'bug']
              });
            } else {
              // Add comment to existing issue
              const commentBody = `Another failure detected. Run: ${runUrl}`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: commentBody
              });
            }
