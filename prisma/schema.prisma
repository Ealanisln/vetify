generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Tenant {
  id             String       @id @default(uuid())
  name           String
  slug           String       @unique
  domain         String?      @unique
  logo           String?
  primaryColor   String?
  secondaryColor String?
  planType       PlanType     @default(PROFESIONAL)
  status         TenantStatus @default(ACTIVE)
  isTrialPeriod  Boolean      @default(true)
  trialEndsAt    DateTime?

  // Enhanced trial tracking
  trialExtendedAt DateTime?
  trialExtendedBy String?
  gracePeriodEnds DateTime?
  lastTrialCheck  DateTime?

  // Enhanced Stripe Integration
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  stripeProductId      String?
  planName             String?
  subscriptionStatus   SubscriptionStatus @default(INACTIVE)
  subscriptionEndsAt   DateTime?

  // Campos para p치gina p칰blica
  publicPageEnabled    Boolean @default(false)
  publicDescription    String? @db.Text
  publicPhone          String?
  publicEmail          String?
  publicAddress        String? @db.Text
  publicHours          Json? // Horarios de atenci칩n
  publicServices       Json? // Servicios destacados
  publicImages         Json? // URLs de im치genes
  publicSocialMedia    Json? // Redes sociales
  publicThemeColor     String? @default("#75a99c")
  publicTheme          String? @default("modern") // Tema predefinido: modern, classic, minimal, vibrant
  publicBookingEnabled Boolean @default(true)

  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  locations           Location[]
  appointments        Appointment[]
  appointmentRequests AppointmentRequest[]
  automationLogs      AutomationLog[]
  businessHours       BusinessHours[]
  cashDrawers         CashDrawer[]
  cashShifts          CashShift[]
  customers           Customer[]
  inventoryItems      InventoryItem[]
  InventoryMovement   InventoryMovement[]
  medicalHistories    MedicalHistory[]
  medicalOrders       MedicalOrder[]
  pets                Pet[]
  reminders           Reminder[]
  roles               Role[]
  sales               Sale[]
  services            Service[]
  staff               Staff[]
  tenantApiKeys       TenantApiKey[]
  tenantInvitations   TenantInvitation[]
  tenantSettings      TenantSettings?
  tenantSubscription  TenantSubscription?
  tenantUsageStats    TenantUsageStats?
  treatmentRecords    TreatmentRecord[]
  treatmentSchedules  TreatmentSchedule[]
  users               User[]
  trialAccessLogs     TrialAccessLog[]
  emailLogs           EmailLog[]
  inventoryTransfers  InventoryTransfer[]
  testimonials        Testimonial[]
  landingPageAnalytics LandingPageAnalytics[]

  @@index([status])
  @@index([slug])
  @@index([domain])
  @@index([trialEndsAt])
  @@index([isTrialPeriod, subscriptionStatus])
}

model Location {
  id        String  @id @default(uuid())
  name      String
  slug      String // URL-friendly identifier
  address   String?
  phone     String?
  email     String?
  timezone  String? @default("America/Mexico_City")
  isActive  Boolean @default(true)
  isPrimary Boolean @default(false) // One primary location per tenant

  // Multi-tenant isolation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations to location-scoped models
  pets           Pet[]
  appointments   Appointment[]
  staff          Staff[]
  inventoryItems InventoryItem[]
  cashDrawers    CashDrawer[]
  services       Service[]
  businessHours  BusinessHours[]
  customers      Customer[]
  sales          Sale[]
  transfersFrom  InventoryTransfer[] @relation("TransfersFrom")
  transfersTo    InventoryTransfer[] @relation("TransfersTo")
  staffLocations StaffLocation[]
  apiKeys        TenantApiKey[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete support

  @@unique([tenantId, slug])
  @@index([tenantId, isActive])
  @@index([tenantId, isPrimary])
}

model Plan {
  id                  String               @id @default(uuid())
  key                 String               @unique
  name                String
  description         String?
  monthlyPrice        Decimal              @db.Decimal(10, 2)
  annualPrice         Decimal              @db.Decimal(10, 2)
  features            Json
  maxUsers            Int
  maxPets             Int
  storageGB           Int
  maxCashRegisters    Int                  @default(1)
  isRecommended       Boolean              @default(false)
  isActive            Boolean              @default(true)
  isMvp               Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  tenantSubscriptions TenantSubscription[]
}

model User {
  id                     String           @id
  tenantId               String?
  email                  String           @unique
  firstName              String?
  lastName               String?
  name                   String?
  phone                  String?
  address                String?
  preferredContactMethod String?
  isActive               Boolean          @default(true)
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
  appointments           Appointment[]
  closedDrawers          CashDrawer[]     @relation("CashDrawer_closedByToUser")
  customers              Customer[]
  openedDrawers          CashDrawer[]     @relation("CashDrawer_openedByToUser")
  medicalOrders          MedicalOrder[]
  reminders              Reminder[]
  sales                  Sale[]
  tenant                 Tenant?          @relation(fields: [tenantId], references: [id])
  userRoles              UserRole[]
  adminAuditLogs         AdminAuditLog[]
  setupTokens            SetupToken[]
  trialAccessLogs        TrialAccessLog[]

  @@index([tenantId])
  @@index([email])
}

model Role {
  id        String     @id @default(uuid())
  tenantId  String?
  key       String
  name      String
  isSystem  Boolean    @default(false)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  tenant    Tenant?    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userRoles UserRole[]

  @@unique([tenantId, key])
}

model UserRole {
  id     String @id @default(uuid())
  userId String
  roleId String
  role   Role   @relation(fields: [roleId], references: [id])
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model Customer {
  id                     String    @id @default(uuid())
  tenantId               String
  locationId             String?
  email                  String?
  firstName              String?
  lastName               String?
  name                   String
  phone                  String?
  address                String?
  preferredContactMethod String?   @default("phone")
  notes                  String?   @db.Text
  isActive               Boolean   @default(true)
  source                 String?   @default("MANUAL")
  needsReview            Boolean   @default(false)
  reviewedAt             DateTime?
  reviewedBy             String?
  mergedFrom             String[]
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  location            Location?            @relation(fields: [locationId], references: [id], onDelete: Restrict)
  pets                Pet[]
  appointments        Appointment[]
  appointmentRequests AppointmentRequest[]
  reminders           Reminder[]
  sales               Sale[]
  testimonials        Testimonial[]
  user                User?                @relation(fields: [userId], references: [id])
  userId              String?

  @@index([tenantId])
  @@index([locationId])
  @@index([tenantId, locationId])
  @@index([email])
  @@index([phone])
  @@index([tenantId, name])
  @@index([tenantId, needsReview])
  @@index([tenantId, source])
}

model Pet {
  id                  String               @id @default(uuid())
  tenantId            String
  locationId          String?
  customerId          String
  internalId          String?
  name                String
  species             String
  breed               String
  dateOfBirth         DateTime
  gender              String
  weight              Decimal?             @db.Decimal(6, 2)
  weightUnit          String?
  microchipNumber     String?
  isNeutered          Boolean              @default(false)
  isDeceased          Boolean              @default(false)
  profileImage        String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  appointments        Appointment[]
  medicalHistories    MedicalHistory[]
  medicalOrders       MedicalOrder[]
  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  location            Location?            @relation(fields: [locationId], references: [id], onDelete: Restrict)
  customer            Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  reminders           Reminder[]
  sales               Sale[]
  treatmentRecords    TreatmentRecord[]
  treatmentSchedules  TreatmentSchedule[]
  appointmentRequests AppointmentRequest[]

  @@index([tenantId, customerId])
  @@index([tenantId])
  @@index([locationId])
  @@index([tenantId, locationId])
  @@index([customerId])
  @@index([name])
}

model MedicalHistory {
  id             String        @id @default(uuid())
  tenantId       String
  petId          String
  visitDate      DateTime
  reasonForVisit String        @db.Text
  diagnosis      String?       @db.Text
  treatment      String?       @db.Text
  notes          String?       @db.Text
  medicalOrderId String?       @unique
  staffId        String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  medicalOrder   MedicalOrder? @relation(fields: [medicalOrderId], references: [id])
  pet            Pet           @relation(fields: [petId], references: [id], onDelete: Cascade)
  staff          Staff?        @relation(fields: [staffId], references: [id])
  tenant         Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([petId])
  @@index([visitDate])
  @@index([medicalOrderId])
  @@index([staffId])
  @@index([tenantId, visitDate])
}

model TreatmentRecord {
  id                 String            @id @default(uuid())
  tenantId           String
  petId              String
  treatmentType      TreatmentType
  productName        String
  administrationDate DateTime
  batchNumber        String?
  manufacturer       String?
  staffId            String?
  notes              String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  vaccineStage       VaccinationStage?
  dewormingType      DewormingType?
  pet                Pet               @relation(fields: [petId], references: [id], onDelete: Cascade)
  staff              Staff?            @relation(fields: [staffId], references: [id])
  tenant             Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([petId, administrationDate])
  @@index([treatmentType])
  @@index([staffId])
}

model TreatmentSchedule {
  id            String            @id @default(uuid())
  tenantId      String
  petId         String
  treatmentType TreatmentType
  productName   String?
  scheduledDate DateTime
  status        TreatmentStatus   @default(SCHEDULED)
  reminderSent  Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  vaccineStage  VaccinationStage?
  dewormingType DewormingType?
  pet           Pet               @relation(fields: [petId], references: [id], onDelete: Cascade)
  tenant        Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([petId, scheduledDate, status])
  @@index([status, scheduledDate])
  @@index([tenantId, status, scheduledDate])
}

model Appointment {
  id         String            @id @default(uuid())
  tenantId   String
  locationId String?
  petId      String
  customerId String?
  staffId    String?
  userId     String?
  dateTime   DateTime
  duration   Int               @default(30)
  reason     String
  notes      String?           @db.Text
  status     AppointmentStatus @default(SCHEDULED)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  location     Location?     @relation(fields: [locationId], references: [id], onDelete: Restrict)
  pet          Pet           @relation(fields: [petId], references: [id], onDelete: Cascade)
  customer     Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  staff        Staff?        @relation(fields: [staffId], references: [id])
  user         User?         @relation(fields: [userId], references: [id])
  testimonials Testimonial[]

  @@index([tenantId])
  @@index([locationId])
  @@index([tenantId, locationId])
  @@index([tenantId, locationId, dateTime])
  @@index([petId])
  @@index([customerId])
  @@index([staffId])
  @@index([userId])
  @@index([dateTime])
  @@index([status])
  @@index([tenantId, status, dateTime])
}

model Reminder {
  id         String         @id @default(uuid())
  tenantId   String
  petId      String?
  customerId String?
  userId     String?
  type       ReminderType
  title      String
  message    String
  dueDate    DateTime
  status     ReminderStatus @default(PENDING)
  sentAt     DateTime?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pet      Pet?      @relation(fields: [petId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  user     User?     @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([petId])
  @@index([customerId])
  @@index([userId])
  @@index([dueDate])
  @@index([status])
  @@index([tenantId, status, dueDate])
}

model Staff {
  id                 String              @id @default(uuid())
  tenantId           String
  locationId         String?
  userId             String?             @unique
  name               String
  position           String
  email              String?             @unique
  phone              String?
  licenseNumber      String?
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  // Public profile fields
  publicBio          String?             @db.Text
  publicPhoto        String?
  specialties        String[]
  showOnPublicPage   Boolean             @default(false)

  appointments            Appointment[]
  inventoryMovements      InventoryMovement[]
  medicalHistories        MedicalHistory[]
  medicalOrders           MedicalOrder[]
  Sale                    Sale[]
  tenant                  Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  location                Location?           @relation(fields: [locationId], references: [id], onDelete: Restrict)
  treatmentRecords        TreatmentRecord[]
  inventoryTransfers      InventoryTransfer[]
  staffLocations          StaffLocation[]
  createdApiKeys          TenantApiKey[]      @relation("ApiKeyCreatedBy")
  cashShifts              CashShift[]         @relation("CashShift_cashier")
  handedOffShifts         CashShift[]         @relation("CashShift_handedOffTo")
  moderatedTestimonials   Testimonial[]       @relation("ModeratedTestimonials")
  invitation              TenantInvitation?   // Pending invitation for this staff

  @@index([tenantId])
  @@index([locationId])
  @@index([tenantId, locationId])
  @@index([isActive])
  @@index([email])
  @@index([userId])
  @@index([tenantId, isActive])
}

model InventoryItem {
  id              String              @id @default(uuid())
  tenantId        String
  locationId      String?
  name            String
  category        InventoryCategory
  description     String?
  activeCompound  String?
  presentation    String?
  measure         String?
  brand           String?
  quantity        Decimal             @default(0) @db.Decimal(8, 2)
  minStock        Decimal?            @db.Decimal(8, 2)
  expirationDate  DateTime?
  status          InventoryStatus     @default(ACTIVE)
  batchNumber     String?
  specialNotes    String?
  storageLocation String? // Physical storage location (e.g., "Shelf A-1", "Refrigerator")
  cost            Decimal?            @db.Decimal(10, 2)
  price           Decimal?            @db.Decimal(10, 2)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  location        Location?           @relation(fields: [locationId], references: [id], onDelete: Restrict)
  movements       InventoryMovement[]
  prescriptions   Prescription[]
  saleItems       SaleItem[]
  transfers       InventoryTransfer[]

  @@index([tenantId])
  @@index([locationId])
  @@index([tenantId, locationId])
  @@index([tenantId, locationId, status])
  @@index([category])
  @@index([name])
  @@index([status])
  @@index([expirationDate])
  @@index([quantity])
  @@index([tenantId, status, quantity])
}

model InventoryMovement {
  id                String        @id @default(uuid())
  tenantId          String
  itemId            String
  type              MovementType
  quantity          Decimal       @db.Decimal(8, 2)
  date              DateTime      @default(now())
  reason            String?
  staffId           String?
  relatedRecordId   String?
  relatedRecordType String?
  notes             String?       @db.Text
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @default(now()) @updatedAt
  item              InventoryItem @relation(fields: [itemId], references: [id])
  staff             Staff?        @relation(fields: [staffId], references: [id])
  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([itemId, date])
  @@index([staffId])
  @@index([type])
}

model MedicalOrder {
  id             String             @id @default(uuid())
  tenantId       String
  petId          String
  staffId        String
  visitDate      DateTime
  diagnosis      String?
  treatment      String?
  notes          String?
  status         MedicalOrderStatus @default(PENDING)
  saleId         String?            @unique
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  userId         String?
  medicalHistory MedicalHistory?
  pet            Pet                @relation(fields: [petId], references: [id], onDelete: Cascade)
  sale           Sale?              @relation(fields: [saleId], references: [id])
  staff          Staff              @relation(fields: [staffId], references: [id])
  tenant         Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  User           User?              @relation(fields: [userId], references: [id])
  prescriptions  Prescription[]

  @@index([tenantId])
  @@index([petId])
  @@index([staffId])
  @@index([status])
  @@index([saleId])
}

model Prescription {
  id           String        @id @default(uuid())
  orderId      String
  productId    String
  quantity     Decimal       @db.Decimal(8, 2)
  unitPrice    Decimal       @db.Decimal(10, 2)
  dosage       String?
  frequency    String?
  duration     String?
  instructions String?       @db.Text
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @default(now()) @updatedAt
  order        MedicalOrder  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product      InventoryItem @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model CashDrawer {
  id               String            @id @default(uuid())
  tenantId         String
  locationId       String?
  openedAt         DateTime          @default(now())
  closedAt         DateTime?
  openedById       String?
  closedById       String?
  initialAmount    Decimal           @db.Decimal(10, 2)
  finalAmount      Decimal?          @db.Decimal(10, 2)
  expectedAmount   Decimal?          @db.Decimal(10, 2)
  difference       Decimal?          @db.Decimal(10, 2)
  status           DrawerStatus      @default(OPEN)
  notes            String?           @db.Text
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  closedBy         User?             @relation("CashDrawer_closedByToUser", fields: [closedById], references: [id], onDelete: SetNull)
  openedBy         User?             @relation("CashDrawer_openedByToUser", fields: [openedById], references: [id], onDelete: SetNull)
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  location         Location?         @relation(fields: [locationId], references: [id], onDelete: Restrict)
  cashTransactions CashTransaction[]
  shifts           CashShift[]

  @@index([tenantId])
  @@index([locationId])
  @@index([tenantId, locationId])
  @@index([openedAt])
  @@index([status])
  @@index([openedById])
  @@index([closedById])
  @@index([tenantId, status, openedAt])
  @@index([tenantId, locationId, status])
}

model CashTransaction {
  id          String          @id @default(uuid())
  drawerId    String
  shiftId     String?
  amount      Decimal         @db.Decimal(10, 2)
  type        TransactionType
  description String?
  relatedId   String?
  relatedType String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @default(now()) @updatedAt
  cashDrawer  CashDrawer      @relation(fields: [drawerId], references: [id], onDelete: Cascade)
  shift       CashShift?      @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  SalePayment SalePayment?

  @@index([drawerId])
  @@index([shiftId])
  @@index([relatedId, relatedType])
  @@index([type])
}

model CashShift {
  id              String      @id @default(uuid())
  tenantId        String
  drawerId        String
  cashierId       String      // Staff asignado

  startedAt       DateTime    @default(now())
  endedAt         DateTime?

  startingBalance Decimal     @db.Decimal(10, 2)
  endingBalance   Decimal?    @db.Decimal(10, 2)
  expectedBalance Decimal?    @db.Decimal(10, 2)
  difference      Decimal?    @db.Decimal(10, 2)

  status          ShiftStatus @default(ACTIVE)
  notes           String?     @db.Text
  handoffNotes    String?     @db.Text

  handedOffToId   String?
  handedOffAt     DateTime?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  tenant          Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  drawer          CashDrawer  @relation(fields: [drawerId], references: [id], onDelete: Cascade)
  cashier         Staff       @relation("CashShift_cashier", fields: [cashierId], references: [id])
  handedOffTo     Staff?      @relation("CashShift_handedOffTo", fields: [handedOffToId], references: [id])
  transactions    CashTransaction[]

  @@index([tenantId])
  @@index([tenantId, drawerId])
  @@index([drawerId, status])
  @@index([cashierId])
}

model Sale {
  id         String     @id @default(uuid())
  tenantId   String
  locationId String?
  customerId String?
  petId      String?
  userId     String?
  staffId    String?
  saleNumber String     @unique
  subtotal   Decimal    @db.Decimal(10, 2)
  tax        Decimal    @default(0) @db.Decimal(10, 2)
  discount   Decimal    @default(0) @db.Decimal(10, 2)
  total      Decimal    @db.Decimal(10, 2)
  status     SaleStatus @default(PENDING)
  notes      String?    @db.Text
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  location     Location?     @relation(fields: [locationId], references: [id], onDelete: Restrict)
  customer     Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  pet          Pet?          @relation(fields: [petId], references: [id])
  user         User?         @relation(fields: [userId], references: [id])
  staff        Staff?        @relation(fields: [staffId], references: [id])
  items        SaleItem[]
  payments     SalePayment[]
  medicalOrder MedicalOrder?

  @@index([tenantId])
  @@index([locationId])
  @@index([customerId])
  @@index([petId])
  @@index([userId])
  @@index([staffId])
  @@index([saleNumber])
  @@index([status])
  @@index([createdAt])
  @@index([tenantId, status, createdAt])
  @@index([tenantId, locationId, status])
}

model SaleItem {
  id            String         @id @default(uuid())
  saleId        String
  itemId        String?
  serviceId     String?
  description   String
  quantity      Decimal        @db.Decimal(8, 2)
  unitPrice     Decimal        @db.Decimal(10, 2)
  discount      Decimal        @default(0) @db.Decimal(10, 2)
  total         Decimal        @db.Decimal(10, 2)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @default(now()) @updatedAt
  inventoryItem InventoryItem? @relation(fields: [itemId], references: [id], onDelete: SetNull)
  sale          Sale           @relation(fields: [saleId], references: [id], onDelete: Cascade)
  service       Service?       @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  @@index([saleId])
  @@index([itemId])
  @@index([serviceId])
}

model SalePayment {
  id                String           @id @default(uuid())
  saleId            String
  paymentMethod     PaymentMethod
  amount            Decimal          @db.Decimal(10, 2)
  paymentDate       DateTime         @default(now())
  transactionId     String?
  notes             String?
  cashTransactionId String?          @unique
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @default(now()) @updatedAt
  cashTransaction   CashTransaction? @relation(fields: [cashTransactionId], references: [id])
  sale              Sale             @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([paymentMethod])
  @@index([paymentDate])
  @@index([cashTransactionId])
}

model Service {
  id                 String          @id @default(uuid())
  tenantId           String
  locationId         String?
  name               String
  description        String?
  category           ServiceCategory
  price              Decimal         @db.Decimal(10, 2)
  duration           Int?
  isActive           Boolean         @default(true)
  // Public page display fields
  isFeatured         Boolean         @default(false)
  publicDisplayOrder Int?
  publicIcon         String?
  publicPriceLabel   String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  saleItems          SaleItem[]
  tenant             Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  location           Location?       @relation(fields: [locationId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([locationId])
  @@index([tenantId, locationId])
  @@index([category])
  @@index([isActive])
  @@index([name])
  @@index([tenantId, isActive, category])
  @@index([tenantId, locationId, isActive])
  @@index([tenantId, isFeatured, publicDisplayOrder])
}

model TenantInvitation {
  id        String       @id @default(uuid())
  tenantId  String
  staffId   String?      @unique // Link to specific staff member
  email     String
  roleKey   String       // Staff position (VETERINARIAN, MANAGER, etc.)
  token     String       @unique
  status    InviteStatus @default(PENDING)
  expiresAt DateTime
  createdAt DateTime     @default(now())

  tenant    Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  staff     Staff?       @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([token])
  @@index([status, email])
  @@index([staffId])
}

model TenantSettings {
  id                      String          @id @default(uuid())
  tenantId                String          @unique
  timezone                String          @default("UTC")
  dateFormat              String          @default("DD/MM/YYYY")
  enableEmailReminders    Boolean         @default(true)
  enableSmsReminders      Boolean         @default(false)
  notificationPreferences Json? // Granular notification preferences by type
  taxRate                 Decimal         @default(0.16) @db.Decimal(5, 4)
  currencyCode            String          @default("USD")
  currencySymbol          String          @default("$")
  appointmentDuration     Int             @default(30)
  defaultStartTime        String          @default("08:00")
  defaultEndTime          String          @default("18:00")
  defaultLunchStart       String?         @default("13:00")
  defaultLunchEnd         String?         @default("14:00")
  defaultSlotDuration     Int             @default(15)
  updatedAt               DateTime        @updatedAt
  tenant                  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  businessHours           BusinessHours[]
}

model BusinessHours {
  id               String         @id @default(uuid())
  tenantId         String
  locationId       String?
  tenantSettingsId String
  dayOfWeek        Int // 0 = Sunday, 1 = Monday, etc.
  isWorkingDay     Boolean        @default(true)
  startTime        String         @default("08:00")
  endTime          String         @default("18:00")
  lunchStart       String?        @default("13:00")
  lunchEnd         String?        @default("14:00")
  slotDuration     Int            @default(15)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  tenant           Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  location         Location?      @relation(fields: [locationId], references: [id], onDelete: Restrict)
  tenantSettings   TenantSettings @relation(fields: [tenantSettingsId], references: [id], onDelete: Cascade)

  @@unique([tenantId, locationId, dayOfWeek])
  @@index([tenantId])
  @@index([locationId])
  @@index([tenantId, locationId])
  @@index([dayOfWeek])
}

model TenantSubscription {
  id                   String             @id @default(uuid())
  tenantId             String             @unique
  planId               String
  stripeSubscriptionId String?
  status               SubscriptionStatus @default(TRIALING)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  plan                 Plan               @relation(fields: [planId], references: [id])
  tenant               Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model TenantApiKey {
  id        String    @id @default(uuid())
  tenantId  String
  name      String
  keyPrefix String
  keyHash   String    @unique
  lastUsed  DateTime?
  expiresAt DateTime?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())

  // API v1 features - location scoping, permissions, rate limiting
  locationId  String? // Scope to specific location (null = all locations)
  scopes      String[] // Permission scopes e.g. ["read:pets", "write:appointments"]
  rateLimit   Int      @default(1000) // Requests per hour
  createdById String? // Staff member who created the key

  // Relations
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  location  Location? @relation(fields: [locationId], references: [id], onDelete: Restrict)
  createdBy Staff?    @relation("ApiKeyCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([isActive])
  @@index([keyHash])
  @@index([tenantId, locationId])
}

model TenantUsageStats {
  id                String   @id @default(uuid())
  tenantId          String   @unique
  totalUsers        Int      @default(0)
  totalPets         Int      @default(0)
  totalAppointments Int      @default(0)
  totalSales        Int      @default(0)
  storageUsedBytes  BigInt   @default(0)
  lastUpdated       DateTime @updatedAt
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model InventoryTransfer {
  id String @id @default(uuid())

  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Restrict)

  fromLocationId String
  fromLocation   Location @relation("TransfersFrom", fields: [fromLocationId], references: [id], onDelete: Restrict)

  toLocationId String
  toLocation   Location @relation("TransfersTo", fields: [toLocationId], references: [id], onDelete: Restrict)

  quantity Decimal        @db.Decimal(8, 2)
  status   TransferStatus @default(PENDING)
  notes    String?        @db.Text

  requestedById String
  requestedBy   Staff  @relation(fields: [requestedById], references: [id], onDelete: Restrict)

  completedAt DateTime?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([inventoryItemId])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([requestedById])
  @@index([status])
  @@index([tenantId, status])
  @@index([tenantId, fromLocationId])
  @@index([tenantId, toLocationId])
}

model StaffLocation {
  id String @id @default(uuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([staffId, locationId])
  @@index([staffId])
  @@index([locationId])
  @@index([staffId, isPrimary])
  @@index([staffId, locationId]) // Composite index for location permission checks
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

enum PlanType {
  BASICO
  PROFESIONAL
  CLINICA
  EMPRESA
  CORPORATIVO
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  PENDING_SETUP
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
  INACTIVE
}

enum TreatmentType {
  VACCINATION
  DEWORMING
  FLEA_TICK
  OTHER_PREVENTATIVE
}

enum TreatmentStatus {
  SCHEDULED
  COMPLETED
  OVERDUE
  CANCELLED
  SKIPPED
}

enum VaccinationStage {
  PUPPY_KITTEN
  ADULT
  SENIOR
  BOOSTER
}

enum DewormingType {
  INTERNAL
  EXTERNAL
  BOTH
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  CANCELLED_CLIENT
  CANCELLED_CLINIC
  NO_SHOW
}

enum ReminderType {
  APPOINTMENT
  TREATMENT
  MEDICATION
  FOOD_REORDER
  CHECKUP
  BIRTHDAY
  OTHER
}

enum ReminderStatus {
  PENDING
  SENT
  ERROR
  DISMISSED
}

enum InventoryCategory {
  MEDICINE
  VACCINE
  DEWORMER
  FLEA_TICK_PREVENTION
  FOOD_PRESCRIPTION
  FOOD_REGULAR
  SUPPLEMENT
  ACCESSORY
  CONSUMABLE_CLINIC
  SURGICAL_MATERIAL
  LAB_SUPPLIES
  HYGIENE_GROOMING
  OTHER
}

enum InventoryStatus {
  ACTIVE
  INACTIVE
  LOW_STOCK
  OUT_OF_STOCK
  EXPIRED
  DISCONTINUED
}

enum MovementType {
  PURCHASE_IN
  SALE_OUT
  RETURN_IN
  ADJUSTMENT_IN
  ADJUSTMENT_OUT
  TRANSFER_IN
  TRANSFER_OUT
  EXPIRY_OUT
}

enum MedicalOrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum DrawerStatus {
  OPEN
  CLOSED
  RECONCILED
}

enum ShiftStatus {
  ACTIVE      // Turno en curso
  ENDED       // Fin normal
  HANDED_OFF  // Entregado a otro cajero
}

enum TransactionType {
  SALE_CASH
  REFUND_CASH
  DEPOSIT
  WITHDRAWAL
  ADJUSTMENT_IN
  ADJUSTMENT_OUT
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  MOBILE_PAYMENT
  CHECK
  INSURANCE
  OTHER
}

enum SaleStatus {
  PENDING
  PAID
  PARTIALLY_PAID
  COMPLETED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum ServiceCategory {
  CONSULTATION
  SURGERY
  VACCINATION
  DEWORMING
  PREVENTATIVE_CARE
  GROOMING
  BOARDING
  DENTAL_CARE
  LABORATORY_TEST
  IMAGING_RADIOLOGY
  HOSPITALIZATION
  EMERGENCY_CARE
  EUTHANASIA
  OTHER
}

// Add this model to track automations
model AutomationLog {
  id           String   @id @default(uuid())
  tenantId     String
  workflowType String // 'PET_WELCOME', 'VACCINATION_REMINDER', etc.
  triggeredBy  String // User ID who triggered
  payload      Json // Data sent to N8N
  status       String // 'SUCCESS', 'FAILED', 'PENDING'
  executionId  String? // N8N execution ID
  error        String? // Error message if failed
  createdAt    DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([workflowType])
  @@index([status])
}

model AppointmentRequest {
  id            String                   @id @default(uuid())
  tenantId      String
  customerId    String
  petId         String? // Mascota vinculada (si se identific칩)
  petName       String // Nombre proporcionado por el usuario
  service       String?
  preferredDate DateTime?
  preferredTime String?
  notes         String?                  @db.Text
  status        AppointmentRequestStatus @default(PENDING)
  source        String                   @default("PUBLIC_BOOKING")

  // Campos para seguimiento de identificaci칩n
  identificationStatus String? // 'existing', 'new', 'needs_review'
  similarCustomerIds   String[] // IDs de posibles duplicados
  reviewNotes          String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])
  pet      Pet?     @relation(fields: [petId], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([tenantId, identificationStatus])
  @@index([petId])
}

enum AppointmentRequestStatus {
  PENDING
  CONFIRMED
  REJECTED
  CANCELLED
  CONVERTED_TO_APPOINTMENT
}

/// -----------------------------------------------
/// Super Admin Setup Support
/// -----------------------------------------------

enum AdminAction {
  ASSIGNED
  REMOVED
  SETUP_COMPLETED
}

model AdminAuditLog {
  id           String      @id @default(uuid())
  action       AdminAction
  performedBy  String?
  targetUserId String
  targetEmail  String
  metadata     Json?
  createdAt    DateTime    @default(now())

  performedByUser User? @relation(fields: [performedBy], references: [id], onDelete: SetNull)

  @@index([action])
  @@index([targetUserId])
  @@index([createdAt])
}

model SetupToken {
  id        String    @id @default(uuid())
  token     String    @unique
  email     String
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  usedBy    String?
  createdAt DateTime  @default(now())

  usedByUser User? @relation(fields: [usedBy], references: [id])

  @@index([token])
  @@index([email])
}

model TrialAccessLog {
  id           String   @id @default(uuid())
  tenantId     String
  userId       String
  feature      String
  action       String
  allowed      Boolean
  denialReason String?
  requestPath  String?
  userAgent    String?
  ipAddress    String?
  createdAt    DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([feature])
  @@index([allowed])
  @@index([createdAt])
  @@index([tenantId, feature])
  @@index([tenantId, userId])
}

model EmailLog {
  id             String        @id @default(uuid())
  tenantId       String
  recipientEmail String
  recipientName  String?
  subject        String
  template       EmailTemplate
  status         EmailStatus   @default(PENDING)
  sentAt         DateTime?
  deliveredAt    DateTime?
  bouncedAt      DateTime?
  failedAt       DateTime?
  error          String?       @db.Text
  resendId       String?       @unique
  metadata       Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, template])
  @@index([recipientEmail])
  @@index([status])
  @@index([createdAt])
  @@index([resendId])
}

enum EmailTemplate {
  APPOINTMENT_CONFIRMATION
  APPOINTMENT_REMINDER
  APPOINTMENT_CANCELLATION
  APPOINTMENT_RESCHEDULED
  APPOINTMENT_STAFF_NOTIFICATION
  LOW_STOCK_ALERT
  TREATMENT_REMINDER
  NEW_USER_REGISTRATION
  NEW_SUBSCRIPTION_PAYMENT
  TESTIMONIAL_REQUEST
  STAFF_INVITATION
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  BOUNCED
  FAILED
}

// ============================================================================
// TESTIMONIALS
// ============================================================================

model Testimonial {
  id            String            @id @default(uuid())
  tenantId      String
  customerId    String?
  appointmentId String?

  // Reviewer information
  reviewerName  String
  reviewerEmail String?

  // Review content
  rating        Int               // 1-5 stars
  text          String            @db.Text

  // Moderation
  status        TestimonialStatus @default(PENDING)
  isFeatured    Boolean           @default(false)
  displayOrder  Int?

  // Submission tracking
  source        String            @default("MANUAL") // MANUAL, POST_APPOINTMENT, PUBLIC_FORM
  submittedAt   DateTime          @default(now())

  // Moderation audit
  moderatedAt   DateTime?
  moderatedById String?
  moderationNote String?          @db.Text

  // Timestamps
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // Relations
  tenant        Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer      Customer?         @relation(fields: [customerId], references: [id], onDelete: SetNull)
  appointment   Appointment?      @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  moderatedBy   Staff?            @relation("ModeratedTestimonials", fields: [moderatedById], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, isFeatured])
  @@index([customerId])
  @@index([appointmentId])
}

enum TestimonialStatus {
  PENDING
  APPROVED
  REJECTED
  ARCHIVED
}

// ============================================================================
// SYSTEM PROMOTIONS
// ============================================================================

model SystemPromotion {
  id              String   @id @default(uuid())
  name            String // Internal name for admin reference
  code            String   @unique // e.g., "LAUNCH_2025", "BLACKFRIDAY"
  isActive        Boolean  @default(false)
  discountPercent Int // 0-100
  durationMonths  Int // How long the discount applies to new subscribers
  startDate       DateTime
  endDate         DateTime
  stripeCouponId  String? // Stripe coupon ID (manually entered)
  badgeText       String // Display text like "游꿀 Oferta de Lanzamiento"
  description     String   @db.Text // Full description shown to users
  applicablePlans String[] // ['BASICO', 'PROFESIONAL'] or empty for all
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String? // Admin user ID who created/modified

  @@index([isActive, endDate])
  @@index([code])
}

// ============================================================================
// LANDING PAGE ANALYTICS
// ============================================================================

model LandingPageAnalytics {
  id        String             @id @default(uuid())
  tenantId  String

  // Event information
  eventType AnalyticsEventType
  eventName String? // e.g., "book_button_click", "contact_view"

  // Page information
  pageSlug  String // "landing", "agendar", "testimonios", "servicios"
  referrer  String? // Referrer URL (external source)
  utmSource String? // UTM tracking parameters
  utmMedium String?
  utmCampaign String?

  // Session (anonymous - no PII)
  sessionId String // UUID generated client-side per session

  // Anonymized metadata
  device  String? // "mobile", "desktop", "tablet"
  browser String? // "Chrome", "Safari", "Firefox", etc.
  country String? // Derived from IP geolocation, not stored

  // Conversion tracking
  conversionId String? // Links to AppointmentRequest.id if conversion

  // Timestamp
  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([tenantId, eventType])
  @@index([tenantId, pageSlug, createdAt])
  @@index([sessionId])
  @@index([conversionId])
}

enum AnalyticsEventType {
  PAGE_VIEW // User viewed a page
  FORM_START // User started filling booking form
  FORM_SUBMIT // User submitted booking form
  CONVERSION // Appointment request created
  BUTTON_CLICK // User clicked a CTA button
  SCROLL_DEPTH // User scrolled to a certain point
}
